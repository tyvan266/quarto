{
  "hash": "325bc3bf6eca3d41fde50e9c2079f2c3",
  "result": {
    "markdown": "---\ntitle: 'Doing iteration with `map` (when vectorized functions are not enough)'\ndate: '2023-10-11'\ndescription: 'Application to look-back windows and the nearest point problem' \nexecute: \n  message: false\n  warning: false\neditor_options: \n  chunk_output_type: console\ncode-annotations: true\ntoc: true\ntoc-depth: 3\n---\n\n\n\n# Looping for free \n\nFunctions in the `tidyverse` suite of libraries are typically **vectorized**. They operate on one or more vector (or *list*) arguments and return a vector (*list*) output. This means we get looping-behavior for free without having to explicitly program the looping structure. \n\n::: callout-note \nIn R, **vectors** are special cases of **lists** where all elements in the list are of the same atomic type (`dbl`, `char`, `logical`, etc.) --- i.e., when they do not hold further objects (or other lists). \n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(tidyverse)\nlibrary(knitr)\nlibrary(kableExtra)\n\nset.seed(12345)\n\ndemo_data <- \n  tribble(\n    ~ \"X\", ~ \"Y\", ~ \"Z\",\n    3, 8, 5,\n    2, 4, 7,\n    6, 3, 8,\n    1, 5, 2\n  )\n```\n:::\n\n\nFor example, consider the follow demo data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkable(demo_data)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> X </th>\n   <th style=\"text-align:right;\"> Y </th>\n   <th style=\"text-align:right;\"> Z </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nSuppose we want to create a new variable `W` on the `data.frame` defined as follows:\n\n  - if `X` is less than `Y`, then `W = Z`\n  - otherwise, `W = 2 * Z` \n  \nWe can achieve this using the *vectorized* `if_else` function wrapped around the `mutate` method for column creation. Let's also create the sum of `X` and `Y` into `V`\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemo_data |> \n  mutate(\n    W = if_else(X < Y, Z, 2 * Z),\n    V = X + Y\n  ) |>\n        kable()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> X </th>\n   <th style=\"text-align:right;\"> Y </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:right;\"> W </th>\n   <th style=\"text-align:right;\"> V </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 11 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 16 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# Performing mutation\n\nExamine the result `W` line-by-line. Is this what we want and expected? Here, yes. When we create a new column via `mutate`, it's tempting to think the operation is happening *row-by-row* (as in a loop). We may even be tempted to *visualize* the computation as proceeding one line at a time, and updating some accompanying placeholder column cell-by-cell with the new result `W` and `V` forming in the end.\n\n**But this is the wrong mental model! And it can lead us astray in more complex scenarios.** \n\nWhen variable field names of a `data.frame` are used in a `tidyverse` transformation, the function call is operating on the *entire column(s)* as inputs. Under a successful `tidyverse` transformation, the result must be compatible with the data table dimensions to modify it appropriately --- or will be made compatible (under the hood) by the `mutate` wrapper.  \n\n\nTo demonstrate, consider calling the function `sum` (in `base` R) on the `X` variable\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(demo_data$X)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 12\n```\n:::\n:::\n\n\nLet's update `demo_data` by creating a new variable but using `base::sum` \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemo_data |> \n  mutate(sumX = sum(X)) |> kable() \n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> X </th>\n   <th style=\"text-align:right;\"> Y </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:right;\"> sumX </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 12 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 12 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 12 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 12 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nNow, was this expected? The purpose of `mutate` is to glue the outputs of calling functions back onto the original data table. But as `sum` operates on a *list* input and returns a *scalar* output, `mutate` does the work of broadcasting the scalar into a vector of the right dimensions and does the re-merging. The key observation is `mutate` handles the intermediate steps, so that we abstract `mutate`ations as taking *list* arguments (supply by the `data.frame` columns) and *eventually returning list outputs* for augmentation and transformation. \n\n::: callout-tip\nA **scalar** is a one-dimensional data type (compared to matrices, lists, data.frames, objects, etc.). Simply, a scalar is a singular value or number, and that's all --- 2 is scalar, but the vector containing the single element two, `[2]`, is not.\n:::\n\nThe (possibly) *vectorized* function calls happen separately, and `mutate`'s job is to transform the table with the new result --- `mutate` does **not perform row-wise looping**.\n\n::: callout-important\nIn the `tidyverse`, transformation of a `data.frame` is a sequence of operations over one or more *(entire) columns*. The correct mental model is that of **column-wise** operation, *not* as **row-wise** operations.\n:::\n\nAs another example, define `M` with base `sum` as \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemo_data |> \n  mutate(M = sum(X, Y + 1)) |> kable() \n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> X </th>\n   <th style=\"text-align:right;\"> Y </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:right;\"> M </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 36 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 36 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 36 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 36 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThe function result is just 36, being the sum of all elements of `X` and---after increased by 1---the transformed elements of `Y`. The *vectorized* addition operator `+` is *different* from the `sum` function that returns a scalar (but also takes vector inputs).\n\n\n# Using `map` \n\nIn essence, `map` allows us to call a (possibly) *vectorized* function repeatedly over a list of *input arguments*. It loops or iterates over the input values, and collects the results into a new list. When used within the `tidyverse` wrapped around `mutate`, `map`ping provides *nested looping* like behavior, where we need to process the values along one or more columns simultaneously (as inputs) while calling some other vectorized operation.\n\n\n::: callout-note\nThe `purrr` family of `map` functions provide iteration of functions over a list of inputs. \n:::\n\n## Thresholding and counting \n\nWe demonstrate with a simple application to *thresholding*. Suppose we have a list of values `X`, and a smaller list of *thresholding values* `T`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(purrr)\n\nX = c(3, 7, 10, 3, 14, 20, 11, 27)\nT = c(3, 10, 15, 22)\n```\n:::\n\n\nWe want to know, at some threshold of interest, how many values in `X` fall *below* the threshold. For the first threshold value 3, we can answer with `sum` over the Boolean vector \n\n\n::: {.cell}\n\n```{.r .cell-code}\nX < 3\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE\n```\n:::\n\n```{.r .cell-code}\nsum(X < 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0\n```\n:::\n:::\n\n\nNow to achieve this for all values in our threshold list, we use `map_dbl` --- the first argument is the list input we want to *loop over* (threshold values), and the second argument is a annonymoys function over `X` and the threshold argument `.t`. The final result here will match the dimensions argument list that we want to run the function over. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmap_dbl(T, \\(.t) sum(X < .t))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0 3 6 7\n```\n:::\n:::\n\n\n\n# Patient look-back windows in medical trials\n\nSuppose we have a cohort of patients coming in for regularly scheduled follow-up visits. A variety of vital signs are taken--- at each visit, vital signs `X`, `Y`, and `Z` are measured. However, sometime patients miss a scheduled appointment, so visit times are not evenly-spaced. Moreover, at certain occasions (say, 30% of the time), a particular vital sign measurement is missed (due to technical difficulties or other causes). The data may appear as follows \n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\npatient_visit_data <- tibble(\n  ID        = rep(1:10, 10),\n  VisitDate = sample(seq(as.Date('2022-01-01'), as.Date('2022-06-30'), by = \"day\"), 100, replace=TRUE), \n  X         = rnorm(100, 30, 10),\n  Y         = rnorm(100, 83, 20),\n  Z         = rnorm(100, 50, 5) \n  ) |> \n  \n  # assume 30% missing rate for each variable\n  mutate_at(\n    vars(X,Y,Z), \n    \\(.x) if_else(sample(x=0:1, size=100, replace=TRUE, prob = c(.70,.30)) == 1, NA, .x)) |> \n  \n  arrange(ID, VisitDate) |> \n  \n  mutate_if(is.numeric, round)\n```\n:::\n\n\n::: callout-tip\nClick `Code` to reveal the simulation script. \n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\npatient_visit_data |> filter(ID == 3) |> kable()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> ID </th>\n   <th style=\"text-align:left;\"> VisitDate </th>\n   <th style=\"text-align:right;\"> X </th>\n   <th style=\"text-align:right;\"> Y </th>\n   <th style=\"text-align:right;\"> Z </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-01-03 </td>\n   <td style=\"text-align:right;\"> 39 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-01-07 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 105 </td>\n   <td style=\"text-align:right;\"> 53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-02-24 </td>\n   <td style=\"text-align:right;\"> 16 </td>\n   <td style=\"text-align:right;\"> 78 </td>\n   <td style=\"text-align:right;\"> 49 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-02-25 </td>\n   <td style=\"text-align:right;\"> 35 </td>\n   <td style=\"text-align:right;\"> 109 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-03-27 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 40 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-04-04 </td>\n   <td style=\"text-align:right;\"> 30 </td>\n   <td style=\"text-align:right;\"> 94 </td>\n   <td style=\"text-align:right;\"> 47 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-04-08 </td>\n   <td style=\"text-align:right;\"> 37 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-04-09 </td>\n   <td style=\"text-align:right;\"> 28 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 52 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-05-25 </td>\n   <td style=\"text-align:right;\"> 36 </td>\n   <td style=\"text-align:right;\"> 103 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 2022-06-01 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 89 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## Map for window aggregations \n\nSuppose our set of tasks are to compute at *each* scheduled visit\n\n  1. The *average* all `X` values taken within the last 30 days (rolling average of available values)\n  2. The *maximum* `Y` value recorded so far, but excluded the current `Y`\n  3. The current value of `Z`, or the most recent one recorded within the last 10 days \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npatient_visit_with_window_summary <- patient_visit_data |> \n  \n  group_by(ID) |> \n  mutate(\n    \n    X_30day_average = \n      map_dbl(VisitDate, \n        \\(.v) mean(X[VisitDate <= .v & VisitDate >= .v - 30], na.rm = TRUE)),\n    \n    Y_max = \n      map_dbl(VisitDate, \n        \\(.v) max(Y[VisitDate <= .v], na.rm = TRUE)),\n    \n    Z_recent = \n      map_dbl(VisitDate, \n        \\(.v) last(Z[VisitDate <= .v - 10], na_rm = TRUE))\n    )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\npatient_visit_with_window_summary |> filter(ID == 3 | ID == 7) |>\n  kable(n = 20) |> column_spec(1:7, border_left = TRUE, border_right = TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> ID </th>\n   <th style=\"text-align:left;\"> VisitDate </th>\n   <th style=\"text-align:right;\"> X </th>\n   <th style=\"text-align:right;\"> Y </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:right;\"> X_30day_average </th>\n   <th style=\"text-align:right;\"> Y_max </th>\n   <th style=\"text-align:right;\"> Z_recent </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-01-03 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 39 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 53 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 39.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> -Inf </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-01-07 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 105 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 53 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 39.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 105 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-02-24 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 16 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 78 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 49 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 16.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 105 </td>\n   <td style=\"text-align:right;\"> 53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-02-25 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 50 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 25.50000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-03-27 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 48 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 40 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 41.50000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-04 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 30 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 94 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 47 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 39.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-08 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 37 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 63 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 38.33333 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 40 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-09 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 28 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 52 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35.75000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 40 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-25 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 36 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 103 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 36.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-06-01 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 89 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 36.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-01-18 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 55 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-02-01 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 24 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 44 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 46 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 29.50000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;\"> 55 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-02-27 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 73 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 29.50000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-06 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 26 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 90 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 56 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 26.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-26 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 24 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 51 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 25.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 56 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-01 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 88 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 25.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 56 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-12 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 92 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 24.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-15 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 56 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 90 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 40.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-28 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 64 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 54 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 56.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-06-16 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 89 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 46 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NaN </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 54 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n::: callout-important\nWhen supplying arguments for `na.rm` or `na_rm`, always provide the full values `TRUE` or `FALSE` instead of using the abbreviated shortcut `T` or `F`. \n:::\n\nTo help spot-check the results (particularly for the rolling 30-day look-back averages), use the general `map` to get list of values meeting the condition at *each visit* (list of lists!)\n\n\n::: {.cell}\n\n```{.r .cell-code}\npatient_visit_with_window_summary <- patient_visit_data |> \n  \n  group_by(ID) |> \n  mutate(\n    \n    Xs_30day = map(VisitDate, \\(.v) X[VisitDate <= .v & VisitDate >= .v - 30]), \n    \n    X_30day_average = \n      map_dbl(VisitDate, \n        \\(.v) mean(X[VisitDate <= .v & VisitDate >= .v - 30], na.rm = TRUE)),\n    \n    Y_max = \n      map_dbl(VisitDate, \n        \\(.v) max(Y[VisitDate <= .v], na.rm = TRUE)),\n    \n    Z_recent = \n      map_dbl(VisitDate, \n        \\(.v) last(Z[VisitDate <= .v], na_rm = TRUE))\n    \n    ) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\npatient_visit_with_window_summary |> filter(ID == 3 | ID == 7) |>\n    kable(n = 20) |> column_spec(1:8, border_left = TRUE, border_right = TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> ID </th>\n   <th style=\"text-align:left;\"> VisitDate </th>\n   <th style=\"text-align:right;\"> X </th>\n   <th style=\"text-align:right;\"> Y </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:left;\"> Xs_30day </th>\n   <th style=\"text-align:right;\"> X_30day_average </th>\n   <th style=\"text-align:right;\"> Y_max </th>\n   <th style=\"text-align:right;\"> Z_recent </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-01-03 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 39 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 53 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 39 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 39.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> -Inf </td>\n   <td style=\"text-align:right;\"> 53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-01-07 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 105 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 53 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 39, NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 39.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 105 </td>\n   <td style=\"text-align:right;\"> 53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-02-24 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 16 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 78 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 49 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 16 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 16.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 105 </td>\n   <td style=\"text-align:right;\"> 49 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-02-25 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 50 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 16, 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 25.50000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-03-27 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 48 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 40 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 35, 48 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 41.50000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 40 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-04 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 30 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 94 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 47 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 48, 30 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 39.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 47 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-08 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 37 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 63 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 48, 30, 37 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 38.33333 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 47 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-09 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 28 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 52 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 48, 30, 37, 28 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35.75000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-25 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 36 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 103 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 36 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 36.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 3 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-06-01 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 89 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 36, NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 36.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 109 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-01-18 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 55 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;\"> 55 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-02-01 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 24 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 44 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 46 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 35, 24 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 29.50000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-02-27 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 73 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 24, 35 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 29.50000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-06 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 26 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 90 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 56 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 26 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 26.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 91 </td>\n   <td style=\"text-align:right;\"> 56 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-04-26 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 24 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 51 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 26, 24 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 25.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-01 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 88 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 26, 24, NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 25.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-12 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 92 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 24, NA, NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 24.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-15 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 56 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 90 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 24, NA, NA, 56 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 40.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-05-28 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 64 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 54 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> NA, NA, 56, NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 56.00000 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 54 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 7 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> 2022-06-16 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 89 </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 46 </td>\n   <td style=\"text-align:left;border-left:1px solid;border-right:1px solid;\"> NA, NA </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> NaN </td>\n   <td style=\"text-align:right;border-left:1px solid;border-right:1px solid;\"> 102 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Composite scores with missing values \n\nWe want to compute and track some composite score at each visit. We would like to use the value taken at the visit time, but we're willing to impute with the closest value 30 days prior. Our composite measure is $X + Y$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npatient_visit_data |> \n  group_by(ID) |> \n  mutate(\n    XplusY = map_dbl(VisitDate, \n      \\(.v) \n        last(\n          X[VisitDate <= .v & VisitDate >= .v - 30], na_rm = TRUE) \n        +\n        last(\n          Y[VisitDate <= .v & VisitDate >= .v - 30], na_rm = TRUE))\n    \n    ) |> \n  \n  filter(ID == 2 | ID == 8) |> kable(n = 20)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> ID </th>\n   <th style=\"text-align:left;\"> VisitDate </th>\n   <th style=\"text-align:right;\"> X </th>\n   <th style=\"text-align:right;\"> Y </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:right;\"> XplusY </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-01-12 </td>\n   <td style=\"text-align:right;\"> 24 </td>\n   <td style=\"text-align:right;\"> 92 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> 116 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-01-15 </td>\n   <td style=\"text-align:right;\"> 34 </td>\n   <td style=\"text-align:right;\"> 113 </td>\n   <td style=\"text-align:right;\"> 47 </td>\n   <td style=\"text-align:right;\"> 147 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-02-20 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 103 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-03-03 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-03-15 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 93 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-04-13 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 52 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-05-04 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 55 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-05-13 </td>\n   <td style=\"text-align:right;\"> 31 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-06-25 </td>\n   <td style=\"text-align:right;\"> 28 </td>\n   <td style=\"text-align:right;\"> 88 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 116 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 2022-06-28 </td>\n   <td style=\"text-align:right;\"> 44 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 59 </td>\n   <td style=\"text-align:right;\"> 132 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-01-02 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-01-11 </td>\n   <td style=\"text-align:right;\"> 24 </td>\n   <td style=\"text-align:right;\"> 74 </td>\n   <td style=\"text-align:right;\"> 56 </td>\n   <td style=\"text-align:right;\"> 98 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-01-25 </td>\n   <td style=\"text-align:right;\"> 28 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 41 </td>\n   <td style=\"text-align:right;\"> 102 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-02-03 </td>\n   <td style=\"text-align:right;\"> 40 </td>\n   <td style=\"text-align:right;\"> 93 </td>\n   <td style=\"text-align:right;\"> 59 </td>\n   <td style=\"text-align:right;\"> 133 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-02-07 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> 133 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-04-16 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 66 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n   <td style=\"text-align:right;\"> 96 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-04-16 </td>\n   <td style=\"text-align:right;\"> 30 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 49 </td>\n   <td style=\"text-align:right;\"> 96 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-05-12 </td>\n   <td style=\"text-align:right;\"> 42 </td>\n   <td style=\"text-align:right;\"> 93 </td>\n   <td style=\"text-align:right;\"> 49 </td>\n   <td style=\"text-align:right;\"> 135 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-05-15 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 102 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n   <td style=\"text-align:right;\"> 144 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2022-05-23 </td>\n   <td style=\"text-align:right;\"> 27 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> 129 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n::: callout-tip\nThe function `last` has an argument called `na_rm` with default value `False`. Here, we want the last **available** measurement recorded when **sorted** by descending date --- which will correspond to the most recent record. \n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}